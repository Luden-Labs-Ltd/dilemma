# Research: Multi-Option Dilemmas (006)

**Feature**: [spec.md](./spec.md)  
**Date**: 2025-01-30

## 1. Data model for variable options (2–10 per dilemma)

**Decision**: Добавить в сущность Dilemma поле `options_count` (integer 2..10, default 2). Тексты вариантов и фидбэк для вариантов A и B остаются в колонках `option_a_*`, `option_b_*`, `feedback_a`, `feedback_b`; для вариантов C–J текст и фидбэк берутся только из i18n по ключам `dilemmas.{name}.option_{letter}_title`, `option_{letter}_description`, `feedback_{letter}`. В БД для вариантов 3–10 колонок не добавляем — все данные из i18n.

**Rationale**: Обратная совместимость: существующие дилемы с двумя вариантами не меняют схему. Миграция — один столбец `options_count` с default 2. Локализация уже реализована через i18n; для третьего и дальнейших вариантов достаточно добавить ключи в en/he/ru. Ограничение 10 вариантов укладывается в буквы A–J без изменения длины полей choice (varchar(1)).

**Alternatives considered**:
- **Nullable columns** `option_c_title`, `option_c_description`, `feedback_c`, … до `option_j_*`: больше миграций и дублирование с i18n; отклонено.
- **JSONB** `options: [{id, title_key, description_key, feedback_key}]`: гибко, но слабее типизация и валидация в TypeORM; отклонено в пользу явного options_count + i18n.

---

## 2. Validation of choice against dilemma's option set

**Decision**: Валидация в два уровня: (1) DTO — `choice` строка из набора `['A','B','C',…,'J']` (class-validator `@IsIn`); (2) в сервисе — загрузка дилемы по имени, проверка `choice` входит в допустимый диапазон по `options_count` (A = 1, B = 2, …, letter = chr(64 + index)). При недопустимом выборе — 400 Bad Request с кодом/ключом ошибки (например, `invalid_choice`).

**Rationale**: Спека требует отклонять выбор, не входящий в список вариантов дилемы (FR-003, FR-005). Допустимые значения зависят от дилемы, поэтому полная проверка только в сервисе после загрузки дилемы.

**Alternatives considered**:
- Только DTO с фиксированным `IsIn(['A',…,'J'])`: допускает выбор C для 2-вариантной дилемы; недостаточно — отклонено.
- Отдельный guard/pipe с инъекцией DilemmasService: возможно, но текущая схема (проверка в сервисе decisions) проще и согласована с существующим кодом.

---

## 3. Path statistics response shape (dynamic keys)

**Decision**: Ответ статистики по дилеме — объект с полем `pathCounts`: ключи — строки траекторий (AA, AB, AC, …, JJ), значения — числа; плюс `totalCompleted`. Для 2-вариантных дилем возвращаем только AA, AB, BA, BB; для 3-вариантных — все 9 комбинаций и т.д. В OpenAPI описать как `additionalProperties: { type: 'integer' }` и/или примеры для 2 и 3 вариантов.

**Rationale**: Спека требует учитывать все допустимые траектории в зависимости от числа вариантов (FR-007). Фиксированный DTO с полями AA, AB, BA, BB не подходит для 3+ вариантов; динамические ключи позволяют не менять контракт при добавлении вариантов.

**Alternatives considered**:
- Массив `{ path: string, count: number }[]`: эквивалентно по информации, но клиентам удобнее объект для быстрого доступа по ключу; оставляем объект.
- Оставить фиксированные AA, AB, BA, BB и добавить поле `other` для остальных траекторий: искажает аналитику; отклонено.

---

## 4. Lifecycle: forbidding option set change after first decision (FR-010)

**Decision**: При любом обновлении дилемы (изменение названия/описания/вариантов), если по дилеме есть хотя бы одна запись в `user_decisions`, проверять: не менялись ли количество вариантов (`options_count`) и не добавлялись/удалялись ли варианты (при текущей модели — только options_count). При попытке изменить — 409 Conflict или 400 с ключом `dilemma_has_decisions`. В текущей кодовой базе нет публичного API создания/обновления дилем (только seed); правило зафиксировать в сервисе/валидации для будущего admin API.

**Rationale**: Спека FR-010 и уточнение сессии: после появления хотя бы одного решения набор вариантов не изменяется.

**Alternatives considered**: Не блокировать изменение, а версионировать дилемы — избыточно для текущего scope; отклонено.

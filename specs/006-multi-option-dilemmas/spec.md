# Feature Specification: Несколько вариантов ответа на дилемы (A, B, C и более)

**Feature Branch**: `006-multi-option-dilemmas`  
**Created**: 2025-01-30  
**Status**: Draft  
**Input**: User description: "нужно сделать так что может быть больше чем 2 варианта ответа на дилемы улсловно пока надо 3 A, B, C в дальнейшем может будет больше вариантов и опять же в каких-то дилемах будет все еще A и B в каких-то A, B, C"

## Clarifications

### Session 2025-01-30

- Q: Максимальное число вариантов на одну дилему — зафиксировать ли один верхний предел для контрактов и валидации? → A: 10 вариантов максимум (B)
- Q: Можно ли изменять набор вариантов дилемы после того, как по ней уже есть решения пользователей? → A: Не менять набор вариантов после появления хотя бы одного решения по дилеме (A)
- Q: Подписи вариантов (A, B, C) — фиксированные буквы или локализуемые? → A: Локализуемые подписи (ключи i18n): текст варианта может отличаться по языкам (B)
- Q: При отсутствии дилем с 3 вариантами — один список или разделение по числу вариантов? → A: Единый список всех активных дилем без разделения по числу вариантов (A)

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Просмотр дилемы с двумя или тремя вариантами (Priority: P1)

Пользователь открывает дилему и видит все доступные варианты ответа: в одних дилемах — два варианта (A и B), в других — три (A, B и C). Количество вариантов определяется самой дилемой.

**Why this priority**: Без отображения правильного числа вариантов пользователь не может сделать осознанный выбор. Это базовое условие для всего флоу принятия решения.

**Independent Test**: Запрос деталей дилемы возвращает список вариантов с их описаниями. Для дилем с 2 вариантами отображаются A и B; для дилем с 3 — A, B и C. Проверяется на наборе дилем с разным числом вариантов.

**Acceptance Scenarios**:

1. **Given** дилема настроена с двумя вариантами (A, B), **When** пользователь запрашивает детали дилемы, **Then** отображаются только варианты A и B с описаниями
2. **Given** дилема настроена с тремя вариантами (A, B, C), **When** пользователь запрашивает детали дилемы, **Then** отображаются варианты A, B и C с описаниями
3. **Given** в системе есть дилемы с разным числом вариантов, **When** пользователь переключается между дилемами, **Then** в каждой дилеме отображается корректное количество вариантов
4. **Given** пользователь просматривает список дилем, **When** в системе есть дилемы с 2 и с 3 вариантами (или только с 2), **Then** отображается единый список всех активных дилем без разделения по числу вариантов

---

### User Story 2 - Первоначальный выбор среди всех вариантов дилемы (Priority: P1)

Пользователь делает первоначальный выбор одного из вариантов (A, B или C в трёхвариантной дилеме; A или B в двухвариантной). Система сохраняет выбор и возвращает фидбэк, соответствующий выбранному варианту.

**Why this priority**: Это ключевое действие пользователя. Поддержка выбора среди N вариантов — основа новой функциональности.

**Independent Test**: Отправка первоначального выбора с указанием одного из допустимых вариантов (например, "A", "B" или "C"). Система создаёт запись решения и возвращает фидбэк для выбранного варианта. Проверка для дилем с 2 и с 3 вариантами.

**Acceptance Scenarios**:

1. **Given** дилема с вариантами A, B, C, **When** пользователь отправляет первоначальный выбор "B", **Then** система сохраняет выбор B и возвращает фидбэк для варианта B
2. **Given** дилема только с A и B, **When** пользователь отправляет выбор "A" или "B", **Then** система сохраняет выбор и возвращает соответствующий фидбэк
3. **Given** дилема с тремя вариантами, **When** пользователь отправляет недопустимый вариант (например, "D"), **Then** система возвращает ошибку валидации
4. **Given** пользователь уже сделал первоначальный выбор по этой дилеме, **When** пользователь повторно отправляет первоначальный выбор, **Then** система возвращает ошибку (выбор уже сделан)

---

### User Story 3 - Финальное решение с возможностью выбора любого варианта (Priority: P1)

После получения фидбэка пользователь подтверждает или меняет решение, выбрав любой из вариантов дилемы (A, B или C при трёх вариантах). Система сохраняет финальный выбор и фиксирует, изменил ли пользователь мнение относительно первоначального выбора.

**Why this priority**: Завершение цикла принятия решения. Поддержка смены решения на любой из N вариантов и учёт траектории (например, A→C, B→A).

**Independent Test**: Отправка финального выбора после первоначального. Система обновляет запись решения (final_choice), вычисляет changed_mind (true, если final_choice ≠ initial_choice) и время принятия решения. Проверка для 2- и 3-вариантных дилем.

**Acceptance Scenarios**:

1. **Given** пользователь сделал первоначальный выбор A в дилеме с A, B, C, **When** пользователь отправляет финальный выбор C, **Then** система сохраняет final_choice=C, changed_mind=true
2. **Given** пользователь сделал первоначальный выбор B, **When** пользователь отправляет финальный выбор B, **Then** система сохраняет final_choice=B, changed_mind=false
3. **Given** пользователь не сделал первоначальный выбор, **When** пользователь пытается отправить финальный выбор, **Then** система возвращает ошибку
4. **Given** пользователь отправляет финальный выбор, не входящий в варианты данной дилемы, **Then** система возвращает ошибку валидации

---

### User Story 4 - Просмотр личной статистики с учётом траекторий (Priority: P2)

Пользователь видит историю своих участий: по каждой дилеме — первоначальный и финальный выбор. Для двухвариантных дилем траектории остаются типа AA, AB, BA, BB; для трёхвариантных — AA, AB, AC, BA, BB, BC, CA, CB, CC и т.д.

**Why this priority**: Прозрачность для пользователя и согласованность с текущей моделью «путь» (path). Не блокирует основной флоу.

**Independent Test**: Запрос «мои решения» возвращает список решений с initial_choice и final_choice; для каждой дилемы отображается корректная траектория в зависимости от числа вариантов.

**Acceptance Scenarios**:

1. **Given** пользователь участвовал в дилемах с 2 и с 3 вариантами, **When** пользователь запрашивает свою историю, **Then** отображаются все решения с правильными траекториями (2- и 3-символьные)
2. **Given** пользователь не участвовал ни в одной дилеме, **When** запрашивает историю, **Then** возвращается пустой список

---

### User Story 5 - Общая статистика по дилеме при разном числе вариантов (Priority: P2)

Пользователь или аналитика видит агрегированную статистику по дилеме: число участников, распределение по траекториям (учитывая все комбинации initial → final), доля изменивших мнение, среднее время принятия решения.

**Why this priority**: Аналитика и контент-менеджмент. Не обязательно для первого релиза мульти-вариантности, но важно для полноты продукта.

**Independent Test**: Запрос статистики по дилеме с 2 и с 3 вариантами. Ответ содержит корректные счётчики по всем возможным траекториям и производным метрикам.

**Acceptance Scenarios**:

1. **Given** дилема с тремя вариантами и есть участники с разными траекториями, **When** запрашивается статистика по дилеме, **Then** отображаются все траектории (AA, AB, AC, BA, BB, BC, CA, CB, CC) с количествами
2. **Given** дилема с двумя вариантами, **When** запрашивается статистика, **Then** отображаются только траектории AA, AB, BA, BB (поведение как сегодня)

---

### Edge Cases

- Дилема с одним вариантом не допускается: у каждой дилемы минимум два варианта (A и B).
- Максимальное число вариантов на дилему — 10 (жёсткий лимит); валидация и контракты используют этот предел.
- При добавлении новой дилемы с тремя (или более) вариантами все варианты должны иметь текст и фидбэк; отсутствие фидбэка для варианта трактуется как ошибка конфигурации и не должно показываться пользователю до исправления.
- Миграция существующих дилем: текущие дилемы с двумя вариантами продолжают работать без изменений; для них не требуется принудительное добавление третьего варианта.
- Жизненный цикл: после появления хотя бы одного решения пользователя по дилеме набор вариантов (количество и идентификаторы A, B, C, …) не изменяется; попытка изменить набор вариантов для такой дилемы MUST отклоняться.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST поддерживать у каждой дилемы переменное количество вариантов ответа: минимум 2, на первом этапе — до 3 (A, B, C), с возможностью расширения в будущем.
- **FR-002**: Система MUST при отображении дилемы показывать только те варианты, которые определены для данной дилемы (2 или 3 и т.д.). Список дилем MUST быть единым для всех активных дилем (без разделения по числу вариантов).
- **FR-003**: Пользователь MUST иметь возможность сделать первоначальный выбор ровно одного из вариантов, определённых для дилемы; выбор значения, не входящего в список вариантов дилемы, MUST отклоняться.
- **FR-004**: Система MUST сохранять первоначальный выбор и возвращать фидбэк, соответствующий выбранному варианту (feedback_a, feedback_b, feedback_c и т.д. в зависимости от числа вариантов).
- **FR-005**: Пользователь MUST иметь возможность зафиксировать финальное решение, выбрав любой из вариантов данной дилемы; система MUST сохранять final_choice и вычислять changed_mind относительно initial_choice.
- **FR-006**: Система MUST вычислять и хранить траекторию (path) как пару initial_choice → final_choice для любого допустимого числа вариантов (2, 3 и более).
- **FR-007**: Личная и агрегированная статистика MUST учитывать все допустимые траектории в зависимости от числа вариантов дилемы (для 2 вариантов — 4 траектории, для 3 — 9, и т.д.).
- **FR-008**: Существующие дилемы с двумя вариантами (A, B) MUST продолжать работать без изменений в поведении для пользователя и данных.
- **FR-009**: Система MUST допускать у одной дилемы не более 10 вариантов ответа; попытка задать более 10 вариантов MUST отклоняться (валидация/ошибка конфигурации).
- **FR-010**: Для дилемы, по которой уже есть хотя бы одно сохранённое решение пользователя, система MUST запрещать изменение набора вариантов (добавление/удаление/переименование вариантов); попытка изменения MUST отклоняться.

### Key Entities *(include if feature involves data)*

- **Дилема**: сущность с переменным числом вариантов (минимум 2). Каждый вариант имеет идентификатор (A, B, C, …) для траекторий и API, а также локализуемые тексты: подпись варианта и текст фидбэка задаются через ключи i18n и могут отличаться по языкам (en, he, ru и др.). Количество вариантов задаётся при создании/настройке дилемы.
- **Решение пользователя (UserDecision)**: связь пользователь–дилема с полями initial_choice и final_choice, принимающими значение одного из вариантов данной дилемы; траектория (path) и флаг changed_mind выводятся из пары initial_choice и final_choice.

## Assumptions

- На первом этапе достаточно поддержать 2 и 3 варианта; архитектура и данные допускают добавление большего числа вариантов без смены модели.
- Идентификаторы вариантов для API и траекторий — буквенные (A, B, C, …); порядок отображения фиксирован (A, B, C, …). Подписи вариантов и тексты фидбэка локализуются через i18n (ключи по языкам); в UI показывается текст выбранного языка.
- Максимальное число вариантов на дилему зафиксировано: 10 (продуктовый и контрактный лимит); при необходимости лимит может быть пересмотрен в новой версии спецификации.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Пользователь может открыть дилему с двумя вариантами и пройти полный цикл (первоначальный выбор → фидбэк → финальное решение) без ошибок, как в текущей системе.
- **SC-002**: Пользователь может открыть дилему с тремя вариантами (A, B, C), выбрать любой из них в качестве первоначального и финального решения и получить корректный фидбэк для выбранного варианта.
- **SC-003**: Статистика (личная и по дилеме) корректно отражает все траектории для дилем с 2 и с 3 вариантами; данные не теряются и не искажаются при смешанном наборе дилем (часть с 2, часть с 3 вариантами).
- **SC-004**: Существующие дилемы и исторические решения пользователей остаются валидными; миграция данных не требует ручного изменения старых записей со стороны пользователя.

# Research: Расширение контекста для AI-фидбэка

**Feature**: `005-enhance-ai-context`  
**Date**: 2026-01-26  
**Phase**: 0 - Research

## Research Questions

### 1. Структура DTO для передачи переводов дилеммы

**Question**: Как лучше структурировать вложенные объекты dilemmaText и dilemmaTextOriginal в DTO?

**Research**:
- Изучена существующая структура FeedbackRequestDto
- Изучена структура translation.json на фронтенде
- Изучены best practices NestJS для вложенных DTOs

**Decision**: Использовать вложенные классы DTO с валидацией через class-validator декораторы. Создать отдельные классы DilemmaTextDto для переиспользования структуры.

**Rationale**:
- Соответствует существующей архитектуре проекта (class-validator)
- Позволяет валидировать вложенные объекты
- Обеспечивает типобезопасность TypeScript
- Легко расширяется для будущих изменений

**Alternatives considered**:
- Плоская структура с префиксами полей - отклонено из-за сложности валидации и читаемости
- Использование Record<string, string> - отклонено из-за потери типобезопасности

---

### 2. Обратная совместимость с существующими запросами

**Question**: Как обеспечить обратную совместимость, если клиент не передает новые поля?

**Research**:
- Изучена текущая реализация buildPrompt метода
- Изучена логика обработки опциональных полей в NestJS
- Изучены паттерны graceful degradation

**Decision**: Новые поля dilemmaText и dilemmaTextOriginal должны быть опциональными (@IsOptional()). Если dilemmaText не передан, использовать существующую логику с i18n. Если dilemmaText передан, но dilemmaTextOriginal нет - использовать только dilemmaText.

**Rationale**:
- Обеспечивает постепенную миграцию клиентов
- Не ломает существующие интеграции
- Позволяет клиентам обновляться по мере готовности

**Alternatives considered**:
- Сделать поля обязательными - отклонено из-за breaking changes
- Версионирование API - отклонено как избыточное для данной фичи

---

### 3. Структура промпта для OpenAI

**Question**: Как лучше структурировать промпт с несколькими языковыми версиями?

**Research**:
- Изучена текущая структура промпта в buildPrompt
- Изучены best practices для multi-language prompts в OpenAI
- Изучены примеры структурированных промптов

**Decision**: Использовать четкие разделители и метки для каждого языка. Структура: инструкция → оригинальный английский текст (если есть) → текст на языке пользователя → выбор пользователя → размышления.

**Rationale**:
- Четкое разделение помогает AI лучше понимать контекст
- Соответствует текущей структуре промпта
- Легко читается и отлаживается

**Alternatives considered**:
- Смешивание языков в одном блоке - отклонено из-за возможной путаницы для AI
- Отдельные промпты для каждого языка - отклонено как избыточное

---

### 4. Валидация вложенных объектов

**Question**: Какие поля внутри dilemmaText должны быть обязательными?

**Research**:
- Изучены требования из спецификации (FR-006)
- Изучена структура данных в translation.json
- Изучены минимальные требования для построения промпта

**Decision**: Обязательные поля в dilemmaText: title, description, options (a и b). Опциональные: subtitle, questionText, reflectionText (могут отсутствовать для некоторых дилемм).

**Rationale**:
- Минимальный набор для построения валидного промпта
- Соответствует структуре данных в translation.json
- Позволяет обрабатывать различные типы дилемм

**Alternatives considered**:
- Все поля обязательные - отклонено из-за различий в структуре дилемм
- Только title обязательный - отклонено как недостаточное для контекста

---

### 5. Обработка отсутствующих полей в промпте

**Question**: Как обрабатывать ситуацию, когда некоторые поля отсутствуют в dilemmaText?

**Research**:
- Изучена текущая логика построения промпта
- Изучены паттерны graceful handling missing data

**Decision**: Если поле отсутствует, пропускать его в промпте. Не добавлять пустые секции. Использовать условную логику при построении промпта.

**Rationale**:
- Избегает путаницы в промпте
- Соответствует принципу graceful degradation
- Упрощает логику построения промпта

**Alternatives considered**:
- Использовать значения по умолчанию - отклонено из-за возможной неточности
- Возвращать ошибку валидации - отклонено как слишком строгое

---

## Technology Decisions

### NestJS DTO Validation

**Decision**: Использовать class-validator с вложенными DTOs для валидации структуры dilemmaText и dilemmaTextOriginal.

**Rationale**: Соответствует конституции проекта и существующей архитектуре.

### OpenAI Prompt Structure

**Decision**: Расширить существующую структуру промпта, добавив секции для оригинального английского текста перед текстом на языке пользователя.

**Rationale**: Минимальные изменения в существующей логике, сохранение читаемости.

---

## Dependencies

### Existing Dependencies
- `@nestjs/common` - для DTOs и валидации
- `class-validator` - для валидации вложенных объектов
- `class-transformer` - для трансформации данных
- `nestjs-i18n` - для fallback логики (если новые поля не переданы)

### No New Dependencies Required

---

## Risks & Mitigations

### Risk 1: Увеличение размера промпта
**Mitigation**: Проверка размера промпта перед отправкой, использование только необходимых полей

### Risk 2: Breaking changes для существующих клиентов
**Mitigation**: Все новые поля опциональные, fallback на существующую логику

### Risk 3: Сложность валидации вложенных объектов
**Mitigation**: Использование проверенных паттернов NestJS, unit тесты для валидации

---

## Open Questions

Все вопросы разрешены в ходе исследования.

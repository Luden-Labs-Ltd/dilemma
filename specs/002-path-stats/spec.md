# Feature Specification: Статистика по комбинациям ответов (AA/AB/BA/BB)

**Feature Branch**: `002-path-stats`  
**Created**: 2026-01-21  
**Status**: Draft  
**Input**: User description: "мне нужно создать роут чтобы можно было получить данные всех комбинацией ответа и на какую комбинацию сколько человек проголосовало, типа А потом А проголовало 20 человек Б потом А проголосовало 10 человек"

## User Scenarios & Testing

### User Story 1 - Получение распределения траекторий по дилеме (Priority: P1)

Пользователь запрашивает статистику по дилеме и видит, сколько участников прошло каждый из 4 путей (AA, AB, BA, BB) после initial и final выбора.

**Why this priority**: Это основная аналитика по поведению пользователей; без нее невозможно понять результаты голосований.

**Independent Test**: Можно полностью протестировать через GET `/api/statistics/paths/{name}` — запрос возвращает объект с ключами AA, AB, BA, BB и количеством пользователей по каждому пути.

**Acceptance Scenarios**:
1. **Given** дилема существует и есть завершённые решения, **When** вызываем GET `/api/statistics/paths/dilemma1`, **Then** ответ содержит ключи AA, AB, BA, BB с корректными числами (0, если нет участников).
2. **Given** нет завершённых решений, **When** вызываем GET `/api/statistics/paths/dilemma1`, **Then** все значения равны 0.
3. **Given** дилема не найдена, **When** вызываем GET `/api/statistics/paths/unknown`, **Then** возвращается 404.

---

### User Story 2 - Фильтр по минимальному числу участников (Priority: P2)

Пользователь может запросить статистику только если дилема имеет минимум N завершённых участников; иначе возвращается предупреждение/0.

**Why this priority**: Полезно для исключения малых выборок; не критично для базового сценария.

**Independent Test**: GET `/api/statistics/paths/{name}?min=10` — если завершённых <10, возвращается сообщение или нули.

**Acceptance Scenarios**:
1. **Given** завершённых решений < min, **When** параметр min=10, **Then** ответ сообщает о недостаточной выборке (или все значения 0).
2. **Given** завершённых решений ≥ min, **When** параметр min=10, **Then** возвращается полноценная статистика.

---

### Edge Cases
- Дилема не существует → 404.
- Нет завершённых решений → все значения 0.
- Параметр min не число или <0 → 400.

## Requirements

### Functional Requirements
- **FR-001**: System MUST provide endpoint для получения распределения путей (AA, AB, BA, BB) по дилеме.
- **FR-002**: Endpoint MUST считать только завершённые решения (final_choice not null).
- **FR-003**: Endpoint MUST возвращать 0 для путей без участников.
- **FR-004**: System MUST return 404 для несуществующей дилемы.
- **FR-005**: System MUST support optional min threshold для минимального числа завершённых участников; при недоборе возвращать нули или предупреждение.
- **FR-006**: System MUST validate query params (min ≥ 0, integer).

### Key Entities
- **Dilemma**: объект, для которого строится статистика путей.
- **UserDecision**: источник initial_choice и final_choice для расчёта путей AA/AB/BA/BB.
- **PathStats**: агрегированные данные по четырём путям.

## Success Criteria

- **SC-001**: GET `/api/statistics/paths/{name}` отдаёт корректные подсчёты AA/AB/BA/BB при наличии данных (проверка против вручную подготовленных фикстур).
- **SC-002**: Для дилемы без завершённых решений все значения равны 0.
- **SC-003**: Нагрузка: запрос выполняется <200 мс на 10k решений в БД (локальный тест/бенч).
- **SC-004**: Валидный 404 для несуществующей дилемы, 400 для невалидного min.
- **SC-005**: Поддерживается min-порог: при недостатке завершённых решений возвращаются нули/предупреждение, без падений.

## Assumptions
- Считаются только решения с заполненным final_choice.
- Время ответа измеряется на локальной машине/дев-стенде без тяжёлой нагрузки.
- Формат ответа: `{ AA: number, AB: number, BA: number, BB: number }` и при желании `totalCompleted`.

